name: Security Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

concurrency:
  group: security-pipeline-${{ github.ref }}
  cancel-in-progress: false

jobs:
  security:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    strategy:
      fail-fast: false
    env:
      REPORT_DIR: ${{ github.workspace }}/reports
      NODE_ENV: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create reports directory
        run: mkdir -p "$REPORT_DIR"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.9.0
          cache: npm
          cache-dependency-path: app/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: src/scanner/requirements.txt

      - name: Install Python dependencies
        run: pip install -r src/scanner/requirements.txt

      - name: Install Node dependencies
        working-directory: app
        run: npm ci

      - name: Build Next.js app
        working-directory: app
        run: npm run build

      - name: Start Next.js server
        id: start_server
        run: |
          cd app
          nohup npm start -- --port 3000 > /tmp/next.log 2>&1 &
          echo $! > /tmp/next.pid
          for i in {1..30}; do
            if curl -sSf http://localhost:3000/login >/dev/null; then
              echo "ready=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            sleep 5
          done
          echo "::error::Next.js server did not become ready"
          tail -n 100 /tmp/next.log || true
          exit 1

      - name: Install GitLeaks
        run: |
          if ! command -v gitleaks >/dev/null 2>&1; then
            curl -sSfL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz \
              | sudo tar -xz -C /usr/local/bin gitleaks
          fi

      - name: Run GitLeaks
        id: gitleaks
        continue-on-error: true
        run: |
          set +e
          gitleaks detect \
            --source . \
            --config gitleaks.toml \
            --report-path "$REPORT_DIR/gitleaks.json" \
            --report-format json \
            --exit-code 1
          EXIT_CODE=$?
          gitleaks detect \
            --source . \
            --config gitleaks.toml \
            --report-path "$REPORT_DIR/gitleaks.sarif" \
            --report-format sarif \
            --exit-code 0
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Run Snyk scan (Node)
        id: snyk_node
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        working-directory: app
        run: |
          set +e
          mkdir -p "$REPORT_DIR"
          snyk test --json-file-output "$REPORT_DIR/snyk_node.json" --sarif-file-output "$REPORT_DIR/snyk_node.sarif" --severity-threshold=high
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      - name: Run Snyk scan (Python)
        id: snyk_python
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set +e
          mkdir -p "$REPORT_DIR"
          snyk test --file=src/scanner/requirements.txt --package-manager=pip --json-file-output "$REPORT_DIR/snyk_python.json" --sarif-file-output "$REPORT_DIR/snyk_python.sarif" --severity-threshold=high
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      - name: Run Custom Python PII Scanner
        id: pii
        continue-on-error: true
        run: |
          set +e
          mkdir -p "$REPORT_DIR"
          python src/scanner/scanner.py --output "$REPORT_DIR/pii_report.json"
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      - name: Run OWASP ZAP Authenticated Scan
        id: zap
        continue-on-error: true
        timeout-minutes: 40
        env:
          REPORT_DIR: ${{ env.REPORT_DIR }}
        run: |
          set +e
          mkdir -p "$REPORT_DIR"
          zap/run-zap.sh
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      - name: Stop Next.js server
        if: always()
        run: |
          if [ -f /tmp/next.pid ]; then
            kill $(cat /tmp/next.pid) || true
          fi
          if [ -f /tmp/next.log ]; then
            echo "--- Next.js server log ---"
            tail -n 200 /tmp/next.log || true
          fi

      - name: Upload scan reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - name: Summarize scan results
        id: summarize
        if: always()
        env:
          GITLEAKS: ${{ steps.gitleaks.outputs.status }}
          SNYK_NODE: ${{ steps.snyk_node.outputs.status }}
          SNYK_PYTHON: ${{ steps.snyk_python.outputs.status }}
          PII: ${{ steps.pii.outputs.status }}
          ZAP: ${{ steps.zap.outputs.status }}
          REPORT_DIR: ${{ env.REPORT_DIR }}
        run: |
          mkdir -p "$REPORT_DIR"
          summary_text=$(printf 'GitLeaks: %s\nSnyk (Node): %s\nSnyk (Python): %s\nPII Scanner: %s\nZAP: %s' "${GITLEAKS:-not-run}" "${SNYK_NODE:-not-run}" "${SNYK_PYTHON:-not-run}" "${PII:-not-run}" "${ZAP:-not-run}")
          printf '%s\n' "$summary_text" > "$REPORT_DIR/scan_summary.txt"
          failed_list=""
          if [ "${GITLEAKS}" = "fail" ]; then failed_list="GitLeaks"; fi
          if [ "${SNYK_NODE}" = "fail" ] || [ "${SNYK_PYTHON}" = "fail" ]; then
            if [ -n "$failed_list" ]; then failed_list="$failed_list Snyk"; else failed_list="Snyk"; fi
          fi
          if [ "${PII}" = "fail" ]; then
            if [ -n "$failed_list" ]; then failed_list="$failed_list PII-Scanner"; else failed_list="PII-Scanner"; fi
          fi
          if [ "${ZAP}" = "fail" ]; then
            if [ -n "$failed_list" ]; then failed_list="$failed_list ZAP"; else failed_list="ZAP"; fi
          fi
          if [ -n "$failed_list" ]; then
            echo "failed=true" >> "$GITHUB_OUTPUT"
            echo "failed_list=$failed_list" >> "$GITHUB_OUTPUT"
          else
            echo "failed=false" >> "$GITHUB_OUTPUT"
            echo "failed_list=" >> "$GITHUB_OUTPUT"
          fi
          summary_single_line=$(echo "$summary_text" | tr '\n' '|' )
          echo "summary=$summary_single_line" >> "$GITHUB_OUTPUT"

      - name: Enforce scan results
        run: |
          if [ "${{ steps.summarize.outputs.failed }}" = "true" ]; then
            echo "One or more scanners reported failures: ${{ steps.summarize.outputs.failed_list }}"
            exit 1
          fi
