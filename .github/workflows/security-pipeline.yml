name: Security Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

concurrency:
  group: security-pipeline-${{ github.ref }}
  cancel-in-progress: false

jobs:
  security:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    strategy:
      fail-fast: false
    env:
      REPORT_DIR: ${{ github.workspace }}/reports
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create reports directory
        run: mkdir -p "$REPORT_DIR"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.9.0
          cache: npm
          cache-dependency-path: app/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: pip
          cache-dependency-path: src/scanner/requirements.txt

      - name: Install Python dependencies
        run: pip install -r src/scanner/requirements.txt

      - name: Install Node dependencies
        working-directory: app
        run: npm ci

      - name: Build Next.js app
        working-directory: app
        run: npm run build

      - name: Start Next.js server
        id: start_server
        run: |
          cd app
          nohup npm start -- --port 3000 > /tmp/next.log 2>&1 &
          echo $! > /tmp/next.pid
          for i in {1..30}; do
            if curl -sSf http://localhost:3000/login >/dev/null; then
              echo "ready=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            sleep 5
          done
          echo "::error::Next.js server did not become ready"
          tail -n 100 /tmp/next.log || true
          exit 1

      - name: Install GitLeaks
        run: |
          if ! command -v gitleaks >/dev/null 2>&1; then
            curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.17.0/gitleaks_8.17.0_linux_x64.tar.gz -o gitleaks.tar.gz
            tar -xzf gitleaks.tar.gz
            sudo mv gitleaks /usr/local/bin/gitleaks
          fi

      - name: Run GitLeaks
        id: gitleaks
        continue-on-error: true
        run: |
          set +e
          gitleaks detect \
            --source . \
            --config gitleaks.toml \
            --report-path "$REPORT_DIR/gitleaks.json" \
            --report-format json \
            --exit-code 1
          EXIT_CODE=$?
          gitleaks detect \
            --source . \
            --config gitleaks.toml \
            --report-path "$REPORT_DIR/gitleaks.sarif" \
            --report-format sarif \
            --exit-code 0
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Run Snyk scan (Node)
        id: snyk_node
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        working-directory: app
        run: |
          set +e
          mkdir -p "$REPORT_DIR"
          snyk test \
            --json-file-output "$REPORT_DIR/snyk_node.json" \
            --sarif-file-output "$REPORT_DIR/snyk_node.sarif" \
            --severity-threshold=high \
            --policy-path "${GITHUB_WORKSPACE}/snyk.policy"
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      - name: Run Snyk scan (Python)
        id: snyk_python
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set +e
          mkdir -p "$REPORT_DIR"
          snyk test --file=src/scanner/requirements.txt --package-manager=pip \
            --json-file-output "$REPORT_DIR/snyk_python.json" \
            --sarif-file-output "$REPORT_DIR/snyk_python.sarif" \
            --severity-threshold=high \
            --policy-path "${GITHUB_WORKSPACE}/snyk.policy"
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      - name: Run Custom Python PII Scanner
        id: pii
        continue-on-error: true
        run: |
          set +e
          mkdir -p "$REPORT_DIR"
          python src/scanner/scanner.py --output "$REPORT_DIR/pii_report.json"
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      - name: Run OWASP ZAP Authenticated Scan
        id: zap
        continue-on-error: true
        timeout-minutes: 40
        env:
          REPORT_DIR: ${{ env.REPORT_DIR }}
        run: |
          set +e
          mkdir -p "$REPORT_DIR"
          zap/run-zap.sh
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      - name: Aggregate and enforce security policy
        id: policy_gate
        if: always()
        env:
          REPORT_DIR: ${{ env.REPORT_DIR }}
          GITLEAKS_EXIT: ${{ steps.gitleaks.outputs.exit_code }}
          SNYK_NODE_EXIT: ${{ steps.snyk_node.outputs.exit_code }}
          SNYK_PYTHON_EXIT: ${{ steps.snyk_python.outputs.exit_code }}
          PII_EXIT: ${{ steps.pii.outputs.exit_code }}
          ZAP_EXIT: ${{ steps.zap.outputs.exit_code }}
        run: |
          mkdir -p "$REPORT_DIR"
          python - <<'PY'
import json
import os
import sys
from pathlib import Path

report_dir = Path("${REPORT_DIR}")
policy_failed = False
summary_lines = []


def parse_snyk_sarif(path: Path) -> int:
    if not path.exists():
        return -1

    with path.open("r", encoding="utf-8") as handle:
        data = json.load(handle)

    count = 0
    for run in data.get("runs", []):
        for result in run.get("results", []):
            severity = (result.get("properties", {}) or {}).get("severity")
            if isinstance(severity, str) and severity.lower() in {"high", "critical"}:
                count += 1
    return count


def parse_pii_report(path: Path) -> int:
    if not path.exists():
        return -1
    with path.open("r", encoding="utf-8") as handle:
        data = json.load(handle)
    return len(data.get("issues", []))


def parse_zap_report(path: Path) -> int:
    if not path.exists():
        return -1
    with path.open("r", encoding="utf-8") as handle:
        data = json.load(handle)

    def alert_is_high(alert: dict) -> bool:
        risk_desc = str(alert.get("riskdesc", "")).lower()
        if risk_desc.startswith("high"):
            return True
        risk_code = str(alert.get("riskcode", ""))
        return risk_code == "3"

    total = 0
    for site in data.get("site", []):
        for alert in site.get("alerts", []):
            if alert_is_high(alert):
                total += 1
    return total


def parse_gitleaks(path: Path) -> int:
    if not path.exists():
        return -1
    with path.open("r", encoding="utf-8") as handle:
        data = json.load(handle)
    return len(data.get("findings", []))


gitleaks_exit = os.getenv("GITLEAKS_EXIT", "?")
gitleaks_findings = parse_gitleaks(report_dir / "gitleaks.json")
if gitleaks_findings >= 0:
    summary_lines.append(f"GitLeaks: {gitleaks_findings} findings (exit {gitleaks_exit})")
    if gitleaks_findings > 0:
        policy_failed = True
else:
    summary_lines.append("GitLeaks: report missing")
    policy_failed = True

snyk_node_high = parse_snyk_sarif(report_dir / "snyk_node.sarif")
snyk_python_high = parse_snyk_sarif(report_dir / "snyk_python.sarif")
snyk_total_high = (snyk_node_high if snyk_node_high > 0 else 0) + (snyk_python_high if snyk_python_high > 0 else 0)
node_exit = os.getenv("SNYK_NODE_EXIT", "?")
python_exit = os.getenv("SNYK_PYTHON_EXIT", "?")

if snyk_node_high >= 0 and snyk_python_high >= 0:
    summary_lines.append(
        f"Snyk: {snyk_total_high} HIGH/CRITICAL vulnerabilities (node={max(snyk_node_high,0)}, python={max(snyk_python_high,0)})"
        f" | exits node={node_exit}, python={python_exit}"
    )
    if snyk_total_high > 0:
        policy_failed = True
else:
    summary_lines.append("Snyk: report missing")
    policy_failed = True

pii_findings = parse_pii_report(report_dir / "pii_report.json")
pii_exit = os.getenv("PII_EXIT", "?")
if pii_findings >= 0:
    summary_lines.append(f"PII: {pii_findings} non-allowlisted findings (exit {pii_exit})")
    if pii_findings > 0:
        policy_failed = True
else:
    summary_lines.append("PII: report missing")
    policy_failed = True

zap_high = parse_zap_report(report_dir / "zap_report.json")
zap_exit = os.getenv("ZAP_EXIT", "?")
if zap_high >= 0:
    summary_lines.append(f"ZAP: {zap_high} HIGH alerts (exit {zap_exit})")
    if zap_high > 0:
        policy_failed = True
else:
    summary_lines.append("ZAP: report missing")
    policy_failed = True

for line in summary_lines:
    print(line)

status_line = "CI FAIL (policy violated)" if policy_failed else "CI PASS (policy upheld)"
print(status_line)

summary_path = report_dir / "policy_summary.txt"
summary_path.write_text("\n".join(summary_lines + [status_line]), encoding="utf-8")

if policy_failed:
    sys.exit(1)
PY

      - name: Upload scan reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - name: Stop Next.js server
        if: always()
        run: |
          if [ -f /tmp/next.pid ]; then
            kill $(cat /tmp/next.pid) || true
          fi
          if [ -f /tmp/next.log ]; then
            echo "--- Next.js server log ---"
            tail -n 200 /tmp/next.log || true
          fi

