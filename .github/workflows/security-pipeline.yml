name: Security Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

concurrency:
  group: security-pipeline-${{ github.ref }}
  cancel-in-progress: false

jobs:
  security:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    strategy:
      fail-fast: false
    env:
      REPORT_DIR: ${{ github.workspace }}/reports

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create reports directory
        run: mkdir -p "$REPORT_DIR"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.9.0
          cache: npm
          cache-dependency-path: app/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: pip
          cache-dependency-path: src/scanner/requirements.txt

      - name: Install Python dependencies
        run: pip install -r src/scanner/requirements.txt

      - name: Install Node dependencies
        working-directory: app
        run: npm ci

      - name: Build Next.js app
        working-directory: app
        run: npm run build

      - name: Start Next.js server
        id: start_server
        run: |
          cd app
          nohup npm start -- --port 3000 > /tmp/next.log 2>&1 &
          echo $! > /tmp/next.pid
          for i in {1..30}; do
            if curl -sSf http://localhost:3000/login >/dev/null; then
              echo "ready=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            sleep 5
          done
          echo "::error::Next.js server did not become ready"
          tail -n 100 /tmp/next.log || true
          exit 1

      - name: Install GitLeaks
        run: |
          if ! command -v gitleaks >/dev/null 2>&1; then
            curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.17.0/gitleaks_8.17.0_linux_x64.tar.gz -o gitleaks.tar.gz
            tar -xzf gitleaks.tar.gz
            sudo mv gitleaks /usr/local/bin/gitleaks
          fi

      - name: Run GitLeaks
        id: gitleaks
        continue-on-error: true
        run: |
          set +e
          gitleaks detect \
            --source . \
            --config gitleaks.toml \
            --report-path "$REPORT_DIR/gitleaks.json" \
            --report-format json \
            --exit-code 1
          EXIT_CODE=$?
          gitleaks detect \
            --source . \
            --config gitleaks.toml \
            --report-path "$REPORT_DIR/gitleaks.sarif" \
            --report-format sarif \
            --exit-code 0
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Run Snyk scan (Node)
        id: snyk_node
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        working-directory: app
        run: |
          set +e
          snyk test \
            --json-file-output "$REPORT_DIR/snyk_node.json" \
            --sarif-file-output "$REPORT_DIR/snyk_node.sarif" \
            --severity-threshold=high \
            --policy-path "${GITHUB_WORKSPACE}/snyk.policy"
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Run Snyk scan (Python)
        id: snyk_python
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set +e
          snyk test \
            --file=src/scanner/requirements.txt \
            --package-manager=pip \
            --json-file-output "$REPORT_DIR/snyk_python.json" \
            --sarif-file-output "$REPORT_DIR/snyk_python.sarif" \
            --severity-threshold=high \
            --policy-path "${GITHUB_WORKSPACE}/snyk.policy"
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Run Custom Python PII Scanner
        id: pii
        continue-on-error: true
        run: |
          set +e
          python src/scanner/scanner.py --output "$REPORT_DIR/pii_report.json"
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Run OWASP ZAP Authenticated Scan
        id: zap
        continue-on-error: true
        timeout-minutes: 40
        run: |
          set +e
          zap/run-zap.sh
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Aggregate and enforce security policy
        id: policy_gate
        if: always()
        env:
          REPORT_DIR: ${{ env.REPORT_DIR }}
          GITLEAKS_EXIT: ${{ steps.gitleaks.outputs.exit_code }}
          SNYK_NODE_EXIT: ${{ steps.snyk_node.outputs.exit_code }}
          SNYK_PYTHON_EXIT: ${{ steps.snyk_python.outputs.exit_code }}
          PII_EXIT: ${{ steps.pii.outputs.exit_code }}
          ZAP_EXIT: ${{ steps.zap.outputs.exit_code }}
        run: |
          python - <<'PY'
          import json
          import os
          import sys
          from pathlib import Path

          report_dir = Path(os.environ["REPORT_DIR"])
          policy_failed = False
          summary = []

          def load_json(p):
              return json.load(p.open()) if p.exists() else None

          # GitLeaks
          gl = load_json(report_dir / "gitleaks.json")
          gl_count = len(gl.get("findings", [])) if gl else -1
          summary.append(f"GitLeaks: {gl_count}")
          if gl_count > 0:
              policy_failed = True

          # Snyk
          def snyk_high(path):
              data = load_json(path)
              if not data:
                  return -1
              return sum(
                  1 for r in data.get("runs", [])
                  for res in r.get("results", [])
                  if str(res.get("properties", {}).get("severity", "")).lower() in ("high", "critical")
              )

          snyk_total = max(snyk_high(report_dir / "snyk_node.sarif"), 0) + max(snyk_high(report_dir / "snyk_python.sarif"), 0)
          summary.append(f"Snyk high/critical: {snyk_total}")
          if snyk_total > 0:
              policy_failed = True

          # PII
          pii = load_json(report_dir / "pii_report.json")
          pii_count = len(pii.get("issues", [])) if pii else -1
          summary.append(f"PII findings: {pii_count}")
          if pii_count > 0:
              policy_failed = True

          # ZAP
          zap = load_json(report_dir / "zap_report.json")
          zap_high = 0
          if zap:
              for site in zap.get("site", []):
                  for alert in site.get("alerts", []):
                      if str(alert.get("riskdesc", "")).lower().startswith("high"):
                          zap_high += 1
          summary.append(f"ZAP HIGH alerts: {zap_high}")
          if zap_high > 0:
              policy_failed = True

          print("\n".join(summary))
          print("CI FAIL" if policy_failed else "CI PASS")
          sys.exit(1 if policy_failed else 0)
          PY

      - name: Upload scan reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - name: Stop Next.js server
        if: always()
        run: |
          if [ -f /tmp/next.pid ]; then
            kill $(cat /tmp/next.pid) || true
          fi
          if [ -f /tmp/next.log ]; then
            echo "--- Next.js server log ---"
            tail -n 200 /tmp/next.log || true
          fi

